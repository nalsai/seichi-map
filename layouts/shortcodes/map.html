<div id="map-container">
  <div id="leafletmap" style="height: 80vh;"></div>
  <div class="m-4">
    <h4>Locations</h4>
    <div id="location-list" class="mb-3"></div>
    <div>
      <button id="show-all" class="btn btn-sm btn-outline-primary me-2">Show All</button>
      <button id="hide-all" class="btn btn-sm btn-outline-secondary">Hide All</button>
    </div>
  </div>
  <div id="error"></div>

  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="imageModalLabel">Location Image</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="fullscreen-image" src="" alt="Full-screen view" style="max-width: 100%; max-height: 90vh;">
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/leaflet.css" />
<script src="/js/leaflet.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const map = L.map('leafletmap', {
      minZoom: 3,
      maxZoom: 18
    }).setView([35.6735, 139.7565], 16);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = {};
    const features = {};
    let geoJSONLayer;

    function loadLocations() {
      fetch('locations.geojson')
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (!feature.id) {
              feature.id = feature.properties.name.replace(/\s+/g, '-').toLowerCase();
            }
            features[feature.id] = feature;
          });

          geoJSONLayer = L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {

              const iconOptions = {
                black: L.icon({
                  iconUrl: '/img/map-icons/black.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                blue: L.icon({
                  iconUrl: '/img/map-icons/blue.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                green: L.icon({
                  iconUrl: '/img/map-icons/green.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                orange: L.icon({
                  iconUrl: '/img/map-icons/orange.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                purple: L.icon({
                  iconUrl: '/img/map-icons/purple.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                red: L.icon({
                  iconUrl: '/img/map-icons/red.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34]
                }),
                tenshisz: L.icon({
                  iconUrl: '/img/map-icons/tenshisz.png',
                  iconSize: [40, 40],
                  iconAnchor: [20, 20],
                  popupAnchor: [0, -12]
                }),
                cafestella: L.icon({
                  iconUrl: '/img/map-icons/cafestella.png',
                  iconSize: [40, 28],
                  iconAnchor: [20, 14],
                  popupAnchor: [0, -12]
                })
              };

              if (feature.properties.hidden === "true") {
                return null;
              }

              const marker = L.marker(latlng, { icon: iconOptions[feature.properties.icon] || iconOptions.blue });
              markers[feature.id] = marker;
              return marker;
            },
            onEachFeature: function (feature, layer) {
              const popupContent = document.createElement('div');
              popupContent.className = 'text-center';
              popupContent.style.width = '240px';

              const nameElement = document.createElement('div');
              nameElement.className = 'fw-bold';
              nameElement.textContent = feature.properties.name;
              popupContent.appendChild(nameElement);

              const images = getImagesArray(feature.properties);

              if (images.length > 0) {
                const imagesContainer = document.createElement('div');

                images.forEach((imageSrc, index) => {
                  const imgContainer = document.createElement('div');
                  imgContainer.style.cursor = 'pointer';

                  const img = document.createElement('img');
                  img.src = imageSrc;
                  img.alt = `${feature.properties.name} Image ${index + 1}`;
                  img.className = 'img-fluid';
                  img.onclick = function () {
                    openFullScreenImage(imageSrc, feature.properties.name);
                  };
                  imgContainer.appendChild(img);
                  imagesContainer.appendChild(imgContainer);
                });

                popupContent.appendChild(imagesContainer);
              }

              if (feature.properties.description) {
                const descElement = document.createElement('div');
                descElement.className = 'text-start mb-2';
                descElement.innerHTML = feature.properties.description;
                popupContent.appendChild(descElement);
              }

              const toggleBtn = document.createElement('button');
              toggleBtn.className = 'btn btn-sm btn-outline-secondary mt-1';
              toggleBtn.textContent = 'Hide from map';
              toggleBtn.onclick = function () {
                const checkbox = document.getElementById(`location-${feature.id}`);
                if (checkbox) {
                  checkbox.checked = false;
                  const event = new Event('change');
                  checkbox.dispatchEvent(event);
                }

                layer.closePopup();
              };
              popupContent.appendChild(toggleBtn);

              layer.bindPopup(popupContent);
            }
          }).addTo(map);

          const bounds = geoJSONLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, {
              padding: [40, 40],
              maxZoom: 16
            });
          }

          createLocationList(data.features);
          applyStoredVisibility();
        })
        .catch(error => {
          console.error('Error loading GeoJSON:', error);
          document.getElementById('error').innerHTML = '<div class="alert alert-danger mb-0 mt-3">Error loading locations data.</div>';
        });
    }

    function getImagesArray(properties) {
      if (properties.images && Array.isArray(properties.images)) {
        return properties.images;
      }
      if (properties.image) {
        return [properties.image];
      }
      return [];
    }

    function openFullScreenImage(imageSrc, title) {
      const modal = new bootstrap.Modal(document.getElementById('imageModal'));
      document.getElementById('imageModalLabel').textContent = title || 'Location Image';
      document.getElementById('fullscreen-image').src = imageSrc;
      modal.show();
    }

    function createLocationList(features) {
      const locationList = document.getElementById('location-list');

      features.forEach(feature => {
        if (feature.properties.hidden === 'true') {
          return;
        }

        const id = feature.id;
        const name = feature.properties.name;
        let coordinates = '';
        if (feature.geometry && feature.geometry.coordinates && feature.geometry.type === 'Point') {
          const [lng, lat] = feature.geometry.coordinates;
          coordinates = `(${lat.toFixed(6)}, ${lng.toFixed(6)})`;
        }

        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'form-check mb-2';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `location-${id}`;
        checkbox.className = 'form-check-input';
        checkbox.checked = true;

        checkbox.addEventListener('change', function () {
          toggleMarkerVisibility(id, this.checked);
          saveVisibilityState(id, this.checked);
        });

        const label = document.createElement('label');
        label.htmlFor = `location-${id}`;
        label.className = 'form-check-label';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'd-block';
        nameSpan.textContent = name;
        label.appendChild(nameSpan);

        if (coordinates) {
          const coordSpan = document.createElement('span');
          coordSpan.className = 'text-muted small d-block';
          coordSpan.textContent = coordinates;
          label.appendChild(coordSpan);
        }

        checkboxItem.appendChild(checkbox);
        checkboxItem.appendChild(label);
        locationList.appendChild(checkboxItem);
      });

      document.getElementById('show-all').addEventListener('click', showAllMarkers);
      document.getElementById('hide-all').addEventListener('click', hideAllMarkers);
    }

    function toggleMarkerVisibility(id, visible) {
      if (markers[id]) {
        if (visible) {
          if (!map.hasLayer(markers[id])) {
            markers[id].addTo(map);
          }
        } else {
          if (map.hasLayer(markers[id])) {
            map.removeLayer(markers[id]);
          }
        }
      }
    }

    function saveVisibilityState(id, visible) {
      const storageKey = 'mapLocationVisibility';
      let visibilityState = JSON.parse(localStorage.getItem(storageKey) || '{}');
      visibilityState[id] = visible;
      localStorage.setItem(storageKey, JSON.stringify(visibilityState));
    }

    function applyStoredVisibility() {
      const storageKey = 'mapLocationVisibility';
      const visibilityState = JSON.parse(localStorage.getItem(storageKey) || '{}');

      Object.keys(visibilityState).forEach(id => {
        const isVisible = visibilityState[id];
        toggleMarkerVisibility(id, isVisible);

        const checkbox = document.getElementById(`location-${id}`);
        if (checkbox) {
          checkbox.checked = isVisible;
        }
      });
    }

    function showAllMarkers() {
      Object.keys(markers).forEach(id => {
        toggleMarkerVisibility(id, true);

        const checkbox = document.getElementById(`location-${id}`);
        if (checkbox) {
          checkbox.checked = true;
        }

        saveVisibilityState(id, true);
      });
    }

    function hideAllMarkers() {
      Object.keys(markers).forEach(id => {
        toggleMarkerVisibility(id, false);

        const checkbox = document.getElementById(`location-${id}`);
        if (checkbox) {
          checkbox.checked = false;
        }

        saveVisibilityState(id, false);
      });
    }

    loadLocations();
  });
</script>